<html>
<body>

<style>
    .container {
        background-color: gray;
        font-family: 'Courier New', Courier, monospace;
        font-size: 16px;
        color: white;
        position: relative; /* for its "absolute" child */
    }
    .board {
        white-space: pre;
        background-color: black;
    }
    .overlay {
        white-space: pre;        
        z-index: 1;
        position: absolute;
        top: 0px;
        left: 0px;
    }
    .btn {
        height: 1lh;
        position: absolute;
        background-color: blue;
        cursor: pointer;
        transition: background-color 0.1s ease;
    }
    .btn:active {
        background-color: black;
    }
    .txt {
        height: 1lh;
        position: absolute;
        /*font-weight: bold;*/
    }
    .hide {
        display: none;
    }
</style>

<div class="container">

<div class="board" id="board">
            @errorMsg                                                   
                                                                        
            ┌────────────────────┐                                      
            │                    │                                      
    !L00!L01│         AND        │                                      
    !S0#0_──┤                    │                                      
            │   @0@1  #DSP00     │!L20!L21                                      
            │         #DSP01  @2_├───┐                                  
    !L10!L11│         #DSP02     │   │  ┌────────────────────┐          
 @S1@v1@1_──┤         #DSP03     │   │  │                    │          
       @OT1 │    @SEL0      @E0  │   └──┤         XOR        │   #L60 0 
            │                    │      │                    │   #L61 1 
            └────────────────────┘      │   @2@5  #DSP20     │          
                                        │         #DSP21  @6_├── @6     
            ┌────────────────────┐      │         #DSP22     │          
            │                    │      │         #DSP23     │          
    !L30!L31│         OR         │   ┌──┤    @SEL2      @E2  │          
    !S3#3_──┤                    │   │  │                    │          
            │   @3@4  #DSP10     │   │  └────────────────────┘          
            │         #DSP11  @5_├───┘                                  
    !L40!L41│         #DSP12     │!L50!L51   !GL                            
 @S4@v4@4_──┤         #DSP13     │           !GT                 
       @OT4 │    @SEL1      @E1  │           !ST                    
            │                    │           !ET                    
            └────────────────────┘           !SI                   
                                             !SEND          @GEN                                                             
</div>

<div class="overlay">
<div class="btn protoBtn" style="top: -1000lh; left: -1000ch">B</div>
<div class="txt protoTxt" style="top: -1000lh; left: -1001ch">L</div>
</div>

</div>
<script>
function parseBoard(s) {
    var locations = {};
    var symbols = {};
    var row = 0;
    var col = 0;
    var regex = /(.*?)([!@#])(\w+)/gs;
    var replaced = s.replace(regex, (all, before, symbol, name) => {
        var lines = before.split("\n");
        if (lines.length == 1) {
            col += lines[0].length;
        } else {
            row += lines.length - 1;
            col = lines.pop().length;
        }
        locations[name] = [row, col];
        symbols[name] = symbol;
        col += 1 + name.length;
        return before + " ".repeat(1 + name.length);
    });
    return [replaced, locations, symbols];
}
// https://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle
function shuffle(arr) {
    for (var i = arr.length - 1; i != 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}
function encrypt(key1, key2, plaintext) {
    return `E,${key1},${key2},${plaintext}`;
}
function decrypt(ciphertext, key1, key2) {
    var prefix = `E,${key1},${key2},`;
    return ciphertext.startsWith(prefix) ? ciphertext.replace(prefix, "") : "";
}
function generateWireLabels() {
    labels = [
        [ '🐱', '🐶' ],
        [ '🐭', '🐰' ],
        [ '🐮', '🐴' ],
        [ '🐷', '🐏' ],
        [ '🐻', '🐵' ],
        [ '🦁', '🦊' ],
        [ '🐪', '🦙' ],
    ].map(row => shuffle(row));
    console.log("labels: ", labels);
}
var gates = [
    ["AND", 0, 1, 2, (a, b) => a & b],
    ["OR", 3, 4, 5, (a, b) => a | b],
    ["XOR", 2, 5, 6, (a, b) => a ^ b]
];
function generateTable(in0Labels, in1Labels, outLabels, fn) {
    return [[0, 0], [0, 1], [1, 0], [1, 1]]
        .map(([v1, v2]) => in0Labels[v1] + in1Labels[v2] + outLabels[fn(v1, v2)]);
}
function generateTabels() {
    tables = gates.map(([name, in0, in1, out, fn]) => generateTable(labels[in0], labels[in1], labels[out], fn));
}
function shuffleTables() {
    tables.forEach(t => shuffle(t));
}
function generateCiphertexts() {
    ciphertexts = tables.map(t => t.map(row => encrypt(...row)));
    console.log("generateCiphertexts: ", ciphertexts);
}
var wires = ['', '', '', '', '', '', ''];
var labels = wires.map(_ => ['', '']);
var tables;
var ciphertexts;
var updaters = [];
var sel = [0, 0, 0];
var errorMsg = "";

var [board, loc, symbols] = parseBoard(document.querySelector("#board").innerText);
document.querySelector("#board").innerText = board;
console.log("loc: ", loc);
console.log("symbols: ", symbols);

function setRow(node, row) { node.style.top = row + "lh"; }
function setCol(node, col) { node.style.left = col + "ch"; }
function clone(protoNode, rowCol, captionFn) {
    var node = protoNode.cloneNode(true);
    setRow(node, rowCol[0]);
    setCol(node, rowCol[1]);
    protoNode.parentNode.appendChild(node);
    updaters.push(() => node.innerText = captionFn());
    return node;
}
var symbolToClass = { "@": "evaluator", "!": "generator", "#": "both" };
function Text(id, expr) {
    var node = clone(document.querySelector(".protoTxt"), loc[id], expr);
    node.classList.add(symbolToClass[symbols[id]]);
    node.id = "id" + id; // to avoid escaping in query selectors
    return node;
}
function Button(id, expr, listener) {
    var node = clone(document.querySelector(".protoBtn"), loc[id], expr);
    node.classList.add(symbolToClass[symbols[id]]);
    node.id = "id" + id;
    node.onclick = listener;
    return node;
}
function updateUI() {
    updaters.forEach((u) => u());
}
function query(id) {
    return document.querySelector("#" + id);
}

Text("errorMsg", () => errorMsg);

for (let w = 0; w < wires.length; w++) { // wire labels and wires
    for (let v = 0; v < 2; v++) {
        Text("L" + w + v, () => labels[w][v]);
    }
    Text(`${w}`, () => wires[w]);
    Text(`${w}_`, () => wires[w]);
}
gates.forEach(([name, in0, in1, out, fn], i) => { // selectors
    Button(`SEL${i}`, () => "▼", () => { sel[i] = (sel[i] + 1) % 4; updateUI(); });
    updaters.push(() => setRow(query("id" + in0), loc["" + in0][0] + sel[i])); // offset sel[i] rows
    updaters.push(() => setRow(query("id" + in1), loc["" + in1][0] + sel[i]));
});

function shakeDisplayString(i, j) {
    var count = 4;
    var h = () => {
        if (count % 2 == 0) {
            display[i][j] = " " + display[i][j];
        } else {
            display[i][j] = display[i][j].substring(1);
        }
        if (--count != 0) setTimeout(h, 80);
        updateUI(); // expensive
    };
    setTimeout(h, 80);
}
[[0, 1, 2, "AND"], [3, 4, 5, "OR"], [2, 5, 6, "XOR"]].forEach(([in0, in1, out, name], i) => {
    Button("E" + i, () => "►", () => {
        if (plaintext = decrypt(ciphertexts[i][sel[i]], wires[in0], wires[in1])) {
            wires[out] = plaintext;
            errorMsg = `Decrypted!  ${wires[in0]} ${name} ${wires[in1]} = ${wires[out]}`;
            display[i][sel[i]] = "";
        } else {
            errorMsg = "Decryption error: Invalid key.";
            shakeDisplayString(i, sel[i]);
        }
        updateUI();
    });
});

function forEachDisplayIndex(fn) {
    for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 4; j++) {
            fn(i, j);
        }
    }
}
function setDisplay(fn) { forEachDisplayIndex((i, j) => display[i][j] = fn(i, j)) }

var display = [['','','',''], ['','','',''], ['','','','']];
forEachDisplayIndex((i, j) => Text("DSP" + i + j, () => display[i][j]));

var inputValues = [0, 0]; // two wires for the evaluator
var OTDone = [0, 0];
Button("S1", () => OTDone[0] ? "" : "▼", () => { inputValues[0] = 1 - inputValues[0]; updateUI() });
Text("v1", () => inputValues[0]);
Button("OT1", () => OTDone[0] ? "" : "►", () => {
    wires[1] = labels[1][inputValues[0]];
    OTDone[0] = 1;
    errorMsg = `Label of ${inputValues[0]} => ${wires[1]} (OT)`;
    updateUI();
});
Button("S4", () => OTDone[1] ? "" : "▼", () => { inputValues[1] = 1 - inputValues[1]; updateUI() });
Text("v4", () => inputValues[1]);
Button("OT4", () => OTDone[1] ? "" : "►", () => {
    wires[4] = labels[4][inputValues[1]];
    OTDone[1] = 1;
    errorMsg = `Label of ${inputValues[1]} => ${wires[4]} (OT)`;
    updateUI();
});

Button("GL", () => "Generate Wire Labels", () => { generateWireLabels(); updateUI(); });
Button("GT", () => "Generate Tables", () => {
    generateTabels();
    setDisplay((i, j) => tables[i][j]);
    updateUI();
});
Button("ST", () => "Shuffle Tables", () => {
    shuffleTables();
    setDisplay((i, j) => tables[i][j]);
    updateUI();
});
Button("ET", () => "Encrypt Tables", () => {
    generateCiphertexts();
    setDisplay((i, j) => "🔒🔒🧳");
    updateUI();
})
{
var i = 0;
Button("S0", () => "▼", () => { wires[0] = labels[0][i]; i = 1 - i; updateUI(); })
}
{
var i = 0;
Button("S3", () => "▼", () => { wires[3] = labels[3][i]; i = 1 - i; updateUI(); })
}
Text("SI", () => "Select Inputs with ▼");
Button("SEND", () => "Send to the Evaluator", () => {
    document.querySelectorAll(".generator").forEach(n => n.classList.add("hide"));
    document.querySelectorAll(".evaluator").forEach(n => n.classList.remove("hide"));
});

var startWithGeneratorMode = ! window.location.href.endsWith("#E");
if (startWithGeneratorMode) {
    document.querySelectorAll(".evaluator").forEach(n => n.classList.add("hide"));
} else {
    document.querySelectorAll(".generator").forEach(n => n.classList.add("hide"));
    generateWireLabels();
    generateTabels();
    shuffleTables();
    generateCiphertexts();
    setDisplay((i, j) => "🔒🔒🧳");
    wires[0] = labels[0][1]; // default input for Alice
    wires[3] = labels[3][0]; // default input for Alice
}
updateUI();
</script>
</body>
</html>
