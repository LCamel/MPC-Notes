<html>
<body>

<style>
    .container {
        background-color: gray;
        font-family: 'Courier New', Courier, monospace;
        font-size: 16px;
        color: white;
        width: 80ch;
        line-height: 1em;
        height: 25lh;
        position: relative; /* for its "absolute" child */
    }
    .board {
        white-space: pre;
        background-color: black;
    }
    .overlay {
        white-space: pre;        
        z-index: 1;
        position: absolute;
        top: 0px;
        left: 0px;
    }
    .btn {
        height: 1lh;
        position: absolute;
        background-color: blue;
        /* outline: 1px solid gray; */
        cursor: pointer;
        transition: background-color 0.1s ease;
    }
    .btn:active {
        background-color: black;
    }
    .txt {
        height: 1lh;
        position: absolute;
        /*font-weight: bold;*/
    }
</style>

<div class="container">

<div class="board" id="board">
            @errorMsg                                                   
                                                                        
            ┌────────────────────┐                                      
            │                    │                                      
            │         AND        │                                      
       @0_──┤                    │                                      
            │   @0@1  @BOX0      │                                      
            │         @BOX1   @2_├───┐                                  
            │         @BOX2      │   │  ┌────────────────────┐          
 @S1@v1@1_──┤         @BOX3      │   │  │                    │          
       @OT1 │    @BARS0     @E0  │   └──┤         XOR        │   @OL0 0 
            │                    │      │                    │   @OL1 1 
            └────────────────────┘      │   @2@5  @BOX8      │          
                                        │         @BOX9   @6_├── @6     
            ┌────────────────────┐      │         @BOX10     │          
            │                    │      │         @BOX11     │          
            │         OR         │   ┌──┤    @BARS2     @E2  │          
       @3_──┤                    │   │  │                    │          
            │   @3@4  @BOX4      │   │  └────────────────────┘          
            │         @BOX5   @5_├───┘                                  
            │         @BOX6      │                                      
 @S4@v4@4_──┤         @BOX7      │                                      
       @OT4 │    @BARS1     @E1  │                                      
            │                    │                                      
            └────────────────────┘                                      
                                                                                                                      
</div>

<div class="overlay">
<div class="btn protoBtn" style="top: -1000lh; left: -1000ch">B</div>
<div class="txt protoTxt" style="top: -1000lh; left: -1001ch">L</div>
</div>

</div>
<script>
function parseBoard(s) {
    var locations = {};
    var row = 0;
    var col = 0;
    var regex = /(.*?)@(\w+)/gs;
    var replaced = s.replace(regex, (all, before, name) => {
        var lines = before.split("\n");
        if (lines.length == 1) {
            col += lines[0].length;
        } else {
            row += lines.length - 1;
            col = lines.pop().length;
        }
        locations[name] = [row, col];
        col += 1 + name.length;
        return before + " ".repeat(1 + name.length);
    });
    return [replaced, locations];
}
// https://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle
function shuffle(arr) {
    for (var i = arr.length - 1; i != 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}
function encrypt(key1, key2, plaintext) {
    return key1 + key2 + plaintext;
}
function decrypt(ciphertext, key1, key2) {
    return ciphertext.startsWith(key1 + key2) ? ciphertext.substring((key1 + key2).length) : undefined;
}

function gateCiphertexts(labels1, labels2, labels3, fn) {
    return [[0, 0], [0, 1], [1, 0], [1, 1]]
        .map(([v1, v2]) => encrypt(labels1[v1], labels2[v2], labels3[fn(v1, v2)]));
}
var labels = [
  [ '🐱', '🐶' ],
  [ '🐭', '🐰' ],
  [ '🐮', '🐴' ],
  [ '🐷', '🐏' ],
  [ '🐻', '🐵' ],
  [ '🦁', '🦊' ],
  [ '🐪', '🦙' ],
].map(row => shuffle(row));
console.log("labels: ", labels);
// 0
// 1  2  6
// 3  5
// 4
var wires = [1, 2, 2, 0, 2, 2, 2].map((v, i) => v < 2 ? labels[i][v] : ' ');
var updaters = [];
var barSel = [0, 0, 0];
var errorMsg = "";

var ciphertexts = [
    gateCiphertexts(labels[0], labels[1], labels[2], (a, b) => a & b),
    gateCiphertexts(labels[3], labels[4], labels[5], (a, b) => a | b),
    gateCiphertexts(labels[2], labels[5], labels[6], (a, b) => a ^ b),
];
console.log("ciphertexts: ", JSON.stringify(ciphertexts)); // copy
ciphertexts.map(gate => shuffle(gate));
console.log("shuffled ciphertexts: ", ciphertexts);

var [board, loc] = parseBoard(document.querySelector("#board").innerText);
console.log("loc: ", loc);
document.querySelector("#board").innerText = board;

function Bar(row, sel, ...objs) {
    updaters.push(() => objs.forEach(o => o.style.top = (row + sel()) + "lh"));
}
function clone(protoNode, rowCol, captionFn) {
    var node = protoNode.cloneNode(true);
    node.style.top = rowCol[0] + "lh";
    node.style.left = rowCol[1] + "ch";
    protoNode.parentNode.appendChild(node);
    updaters.push(() => node.innerText = captionFn());
    return node;
}
function Text(id, expr) {
    var node = clone(document.querySelector(".protoTxt"), loc[id], expr);
    node.id = "id" + id; // to avoid escaping in query selectors
    return node;
}
function Button(rowCol, expr, listener) {
    var node = clone(document.querySelector(".protoBtn"), rowCol, expr);
    node.onclick = listener;
    return node;
}
function updateUI() {
    updaters.forEach((u) => u());
}
function query(id) {
    return document.querySelector("#" + id);
}

Text("errorMsg", () => errorMsg);

for (let w = 0; w < wires.length; w++) {
    Text(`${w}`, () => wires[w]);
    Text(`${w}_`, () => wires[w]);
}
Bar(loc["0"][0], () => barSel[0], query("0"), query("1"));
Bar(loc["3"][0], () => barSel[1], query("3"), query("4"));
Bar(loc["2"][0], () => barSel[2], query("2"), query("5"));
for (let i = 0; i < 3; i++) {
    Button(loc[`BARS${i}`], () => "▼", () => { barSel[i] = (barSel[i] + 1) % 4; updateUI() });
}

Text("OL0", () => labels[6][0]);
Text("OL1", () => labels[6][1]);

function shakeBoxString(i) {
    var count = 4;
    var h = () => {
        if (count % 2 == 0) {
            boxes[i] = " " + boxes[i];
        } else {
            boxes[i] = boxes[i].substring(1);
        }
        if (--count != 0) setTimeout(h, 80);
        updateUI(); // expensive
    };
    setTimeout(h, 80);
}
Button(loc["E0"], () => "►", () => {
    if (plaintext = decrypt(ciphertexts[0][barSel[0]], wires[0], wires[1])) {
        wires[2] = plaintext;
        errorMsg = `Decrypted!  ${wires[0]} AND ${wires[1]} = ${wires[2]}`;
        boxes[0 + barSel[0]] = "";
    } else {
        errorMsg = "Decryption error: Invalid key.";
        shakeBoxString(0 + barSel[0]);
    }
    updateUI();
});
Button(loc["E1"], () => "►", () => {
    if (plaintext = decrypt(ciphertexts[1][barSel[1]], wires[3], wires[4])) {
        wires[5] = plaintext;
        errorMsg = `Decrypted!  ${wires[3]} OR ${wires[4]} = ${wires[5]}`;
        boxes[4 + barSel[1]] = "";
    } else {
        errorMsg = "Decryption error: Invalid key.";
        shakeBoxString(4 + barSel[1]);
    }
    updateUI();
});
Button(loc["E2"], () => "►", () => {
    if (plaintext = decrypt(ciphertexts[2][barSel[2]], wires[2], wires[5])) {
        wires[6] = plaintext;
        errorMsg = `Decrypted!  ${wires[2]} XOR ${wires[5]} = ${wires[6]}`;
        boxes[8 + barSel[2]] = "";
    } else {
        errorMsg = "Decryption error: Invalid key.";
        shakeBoxString(8 + barSel[2]);
    }
    updateUI();
});

var boxes = [];
for (let i = 0; i < 12; i++) {
    boxes.push("🔒🔒🧳")
    Text("BOX" + i, () => boxes[i]);
}

var inputValues = [0, 0]; // two wires for the evaluator
var OTDone = [0, 0];
Button(loc["S1"], () => OTDone[0] ? "" : "▼", () => { inputValues[0] = 1 - inputValues[0]; updateUI() });
Text("v1", () => inputValues[0]);
Button(loc["OT1"], () => OTDone[0] ? "" : "►", () => {
    wires[1] = labels[1][inputValues[0]];
    OTDone[0] = 1;
    errorMsg = `Label of ${inputValues[0]} => ${wires[1]} (OT)`;
    updateUI();
});
Button(loc["S4"], () => OTDone[1] ? "" : "▼", () => { inputValues[1] = 1 - inputValues[1]; updateUI() });
Text("v4", () => inputValues[1]);
Button(loc["OT4"], () => OTDone[1] ? "" : "►", () => {
    wires[4] = labels[4][inputValues[1]];
    OTDone[1] = 1;
    errorMsg = `Label of ${inputValues[1]} => ${wires[4]} (OT)`;
    updateUI();
});

updateUI();
</script>
</body>
</html>
