<!DOCTYPE html>
<meta charset="utf-8">
<style>
  .node rect {
    fill: #999;
    stroke: #555;
    stroke-width: 1.5px;
  }
  .node text {
    font: 12px sans-serif;
  }
  .link {
    fill: none;
    stroke: #555;
    stroke-width: 1.5px;
  }
</style>
<svg width="960" height="800"></svg>
<script src="https://d3js.org/d3.v6.min.js"></script>
<script>
  var L = 3; // 設置樹的高度

  function createFullBinaryTree(level, path = "") {
    if (level === 0) {
      return { 
        name: `Leaf`,
        textLines: ["Line 1", "Line 2", "Line 3", "Line 4"],
        id: "id" + path,
        leafIndex: parseInt(path, 2), // 將路徑轉換為二進制數字
        children: []
      };
    }
    return {
      name: `Level ${L - level}`,
      textLines: ["Line 1", "Line 2", "Line 3", "Line 4"],
      id: "id" + path,
      children: [
        createFullBinaryTree(level - 1, path + "0"),
        createFullBinaryTree(level - 1, path + "1")
      ]
    };
  }

  var data = createFullBinaryTree(L);

  var width = 960;
  var height = 800;

  var svg = d3.select("svg")
              .attr("width", width)
              .attr("height", height)
              .append("g")
              .attr("transform", "translate(480, 750)"); // 從底部偏移以避免超出

  var treeLayout = d3.tree().size([width - 100, height - 200]); // 增加寬度，減少高度以避免節點超出範圍

  var root = d3.hierarchy(data);

  treeLayout(root);

  // 計算每個節點的水平位置
  var nodeWidth = 100;
  var nodeHeight = 80;

  var leaves = root.leaves();
  var spacing = (width - 2 * nodeWidth) / (leaves.length - 1);

  leaves.forEach((d, i) => {
    d.x = i * spacing - width / 2 + nodeWidth / 2;
  });

  function updatePosition(node) {
    if (node.children) {
      node.children.forEach(updatePosition);
      node.x = node.children.reduce((sum, child) => sum + child.x, 0) / node.children.length;
    }
  }

  updatePosition(root);

  svg.selectAll('.link')
     .data(root.links())
     .enter()
     .append('path')
     .attr('class', 'link')
     .attr('d', d3.linkVertical()
                 .x(function(d) { return d.x; })
                 .y(function(d) { return -d.y; })); // 調整連接線的 y 座標

  var nodes = svg.selectAll(".node")
                 .data(root.descendants())
                 .enter()
                 .append("g")
                 .attr("class", "node")
                 .attr("transform", function(d) { return "translate(" + d.x + "," + -d.y + ")"; }) // 調整節點的 y 座標

  nodes.append("rect")
       .attr("width", nodeWidth)
       .attr("height", nodeHeight)
       .attr("x", -nodeWidth / 2)
       .attr("y", -nodeHeight / 2)
       .attr("id", function(d) { return d.data.id; }); // 設置 rect 的 ID

  nodes.selectAll("text.lines")
       .data(function(d) { return d.data.textLines; })
       .enter()
       .append("text")
       .attr("class", "lines")
       .attr("dy", function(d, i) { return -nodeHeight / 2 + 15 + i * 15; }) // 調整每行文字的位置
       .attr("x", 0)
       .style("text-anchor", "middle")
       .text(function(d) { return d; });

  // 添加葉節點上方的數字
  svg.selectAll(".leaf-label")
     .data(leaves)
     .enter()
     .append("text")
     .attr("class", "leaf-label")
     .attr("x", function(d) { return d.x; })
     .attr("y", function(d) { return -d.y - nodeHeight / 2 - 10; }) // 顯示在葉節點的上方
     .attr("text-anchor", "middle")
     .text(function(d) { return d.data.leafIndex; }); // 顯示葉節點的索引

  function f(id) {
    d3.select("#" + id).style("fill", "orange");
  }

  // 範例：呼叫 f("id01") 使 ID 為 "id01" 的 rect 變色
  setTimeout(function() {
    f("id01");
  }, 1000);
</script>
